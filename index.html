<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA v3.5 | Hybrid Optical Engine</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --bg: #050505;
            --panel: #0f1115;
            --text: #e0e0e0;
            --border: #333;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.05);
            text-align: center;
        }

        h1 {
            margin: 0;
            font-weight: 300;
            letter-spacing: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            background: #222;
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            border: 1px solid #444;
            vertical-align: middle;
        }

        /* Drop Zone */
        .drop-zone {
            margin-top: 30px;
            border: 2px dashed #333;
            border-radius: 12px;
            padding: 60px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.01);
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(0, 243, 255, 0.05);
            box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1);
        }

        .drop-zone p { color: #888; font-size: 1.1rem; }
        
        /* Console Log */
        .console {
            margin-top: 20px;
            background: #000;
            border: 1px solid #222;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            text-align: left;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #aaa;
        }
        
        .log-entry { margin-bottom: 5px; border-left: 3px solid transparent; padding-left: 10px; }
        .log-info { border-color: #555; }
        .log-success { border-color: var(--primary); color: var(--primary); }
        .log-error { border-color: #ff3355; color: #ff3355; }
        .log-cloud { border-color: var(--secondary); color: #d68dfc; }

        /* Buttons & Loader */
        .btn-group { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: none;
            transition: 0.2s;
        }

        .btn-download { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(0,243,255,0.4); }
        .btn-download:hover { background: #fff; }
        
        .btn-reset { background: #222; color: #fff; border: 1px solid #444; display: inline-block; }
        .btn-reset:hover { background: #333; }

        .loader {
            width: 100%; height: 4px; background: #222; margin-top: 15px;
            border-radius: 2px; overflow: hidden; display: none;
        }
        .loader-bar { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 0.3s; }

        canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>AURA <span class="badge">v3.5 STABLE</span></h1>
    <p style="color:#666; font-size:0.9rem;">Hybrid Optical Data Matrix | Firestore Linked</p>

    <div class="drop-zone" id="dropZone">
        <p>üìÇ Drag & Drop File to Encode<br>üñºÔ∏è Drag & Drop Image to Decode</p>
        <input type="file" id="fileInput" hidden>
    </div>

    <div class="loader" id="loader"><div class="loader-bar" id="loaderBar"></div></div>

    <div class="console" id="consoleLog">
        <div class="log-entry log-info">> System Initialized...</div>
    </div>

    <div class="btn-group">
        <a id="downloadBtn" class="btn btn-download">‚¨á DOWNLOAD CODE</a>
        <button class="btn btn-reset" onclick="location.reload()">‚Üª RESET</button>
    </div>

    <canvas id="processor"></canvas>
</div>

<script>
    /**
     * AURA v3.5 - Bug Fixed & Polished
     * Features: Padding Fix, Metadata Sync, Color Safety
     */

    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyD60VG7aqXr-3TFKBdQRT8XbaEl54J3f8s",
        authDomain: "experiment-26a5c.firebaseapp.com",
        projectId: "experiment-26a5c",
        storageBucket: "experiment-26a5c.firebasestorage.app",
        messagingSenderId: "791493232373",
        appId: "1:791493232373:web:f1fb821e86752ea7a4a7bc"
    };

    // Init Firebase with Error Handling
    try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        log("Firebase connection established.", "cloud");
    } catch (e) {
        log("Firebase Error: " + e.message, "error");
    }

    // --- 2. DOM ELEMENTS ---
    const ui = {
        dropZone: document.getElementById('dropZone'),
        fileInput: document.getElementById('fileInput'),
        console: document.getElementById('consoleLog'),
        canvas: document.getElementById('processor'),
        ctx: document.getElementById('processor').getContext('2d', { willReadFrequently: true, alpha: false }),
        dlBtn: document.getElementById('downloadBtn'),
        loader: document.getElementById('loader'),
        loaderBar: document.getElementById('loaderBar')
    };

    // --- 3. EVENT HANDLERS ---
    ui.dropZone.onclick = () => ui.fileInput.click();
    ui.fileInput.onchange = (e) => processFile(e.target.files[0]);
    ui.dropZone.ondragover = (e) => { e.preventDefault(); ui.dropZone.style.borderColor = "#00f3ff"; };
    ui.dropZone.ondragleave = () => { ui.dropZone.style.borderColor = "#333"; };
    ui.dropZone.ondrop = (e) => {
        e.preventDefault();
        ui.dropZone.style.borderColor = "#333";
        processFile(e.dataTransfer.files[0]);
    };

    async function processFile(file) {
        if (!file) return;
        ui.dlBtn.style.display = 'none';
        
        if (file.type === "image/png") {
            log("Image detected. Attempting decode...", "info");
            decode(file);
        } else {
            log(`File detected: ${file.name} (${(file.size/1024).toFixed(2)} KB)`, "info");
            encode(file);
        }
    }

    // --- 4. ENCODE LOGIC (Fixed) ---
    async function encode(file) {
        try {
            loading(10);
            const fileId = "AURA-" + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            log(`Generated ID: ${fileId}`, "success");

            // 1. Read File
            const buffer = await file.arrayBuffer();
            const rawData = new Uint8Array(buffer);
            loading(30);

            // 2. Sync Metadata (Cloud)
            log("Syncing metadata to Firestore...", "cloud");
            await db.collection("aura_registry").doc(fileId).set({
                name: file.name,
                size: file.size,
                type: file.type,
                date: new Date().toISOString()
            });

            // 3. Prepare Payload (ID + Separator + Data)
            const separator = ":::";
            const header = new TextEncoder().encode(fileId + separator);
            
            // 4. PADDING FIX: Ensure total length is divisible by 3 (RGB)
            const totalLen = header.length + rawData.length;
            const padding = (3 - (totalLen % 3)) % 3; 
            const finalLen = totalLen + padding;

            const finalBuffer = new Uint8Array(finalLen);
            finalBuffer.set(header, 0);
            finalBuffer.set(rawData, header.length);
            // Padding bytes remain 0 automatically

            loading(60);
            log("Rendering optical matrix...", "info");

            // 5. Calculate Grid Size
            const totalPixels = finalBuffer.length / 3;
            const side = Math.ceil(Math.sqrt(totalPixels));
            
            ui.canvas.width = side;
            ui.canvas.height = side;
            
            const imgData = ui.ctx.createImageData(side, side);
            
            // 6. Fast Pixel Writing
            for (let i = 0; i < totalPixels; i++) {
                const bufIdx = i * 3;
                const pixIdx = i * 4;
                
                imgData.data[pixIdx] = finalBuffer[bufIdx];     // R
                imgData.data[pixIdx + 1] = finalBuffer[bufIdx+1]; // G
                imgData.data[pixIdx + 2] = finalBuffer[bufIdx+2]; // B
                imgData.data[pixIdx + 3] = 255; // Alpha (Critical for visibility)
            }

            ui.ctx.putImageData(imgData, 0, 0);
            loading(100);

            // 7. Download Ready
            ui.dlBtn.href = ui.canvas.toDataURL("image/png");
            ui.dlBtn.download = `CODE_${file.name}.png`;
            ui.dlBtn.style.display = "inline-block";
            log("Encoding Complete! Code ready for download.", "success");

        } catch (err) {
            log("Error: " + err.message, "error");
        }
    }

    // --- 5. DECODE LOGIC (Fixed) ---
    async function decode(file) {
        try {
            loading(20);
            const img = new Image();
            img.src = URL.createObjectURL(file);
            
            img.onload = async () => {
                ui.canvas.width = img.width;
                ui.canvas.height = img.height;
                ui.ctx.drawImage(img, 0, 0);
                
                const imgData = ui.ctx.getImageData(0, 0, img.width, img.height);
                const pixels = imgData.data;
                
                // Extract RGB Bytes
                const totalBytes = (pixels.length / 4) * 3;
                const buffer = new Uint8Array(totalBytes);
                
                for (let i = 0, j = 0; i < pixels.length; i += 4, j += 3) {
                    buffer[j] = pixels[i];
                    buffer[j+1] = pixels[i+1];
                    buffer[j+2] = pixels[i+2];
                }

                // Find ID
                const decoder = new TextDecoder();
                // Scan first 100 bytes for header
                const headStr = decoder.decode(buffer.subarray(0, 100));
                const splitParts = headStr.split(":::");
                
                if (splitParts.length < 2) {
                    log("Error: No valid AURA signature found.", "error");
                    return;
                }

                const fileId = splitParts[0];
                const headerLen = new TextEncoder().encode(fileId + ":::").length;

                log(`Signature Found: ${fileId}`, "success");
                loading(50);
                
                // Fetch Metadata
                log("Fetching file info from Cloud...", "cloud");
                const doc = await db.collection("aura_registry").doc(fileId).get();
                
                if (!doc.exists) {
                    log("Error: Metadata not found or expired.", "error");
                    return;
                }

                const meta = doc.data();
                log(`Recovering: ${meta.name}`, "info");

                // Extract Exact Data (Trimming Padding)
                const fileData = buffer.subarray(headerLen, headerLen + meta.size);
                
                loading(100);
                downloadRecovered(fileData, meta.name, meta.type);
            };
        } catch (err) {
            log("Decode Error: " + err.message, "error");
        }
    }

    // --- 6. UTILITIES ---
    function downloadRecovered(data, name, type) {
        const blob = new Blob([data], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        log("File Downloaded Successfully!", "success");
    }

    function log(msg, type) {
        const div = document.createElement('div');
        div.className = `log-entry log-${type}`;
        div.innerText = `> ${msg}`;
        ui.console.appendChild(div);
        ui.console.scrollTop = ui.console.scrollHeight;
    }

    function loading(pct) {
        ui.loader.style.display = 'block';
        ui.loaderBar.style.width = pct + "%";
        if(pct >= 100) setTimeout(() => ui.loader.style.display = 'none', 1500);
    }

</script>
</body>
</html>
