<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AURA v3.0 | Ultimate Hybrid Engine</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #00f0ff; --s: #7000ff; --bg: #030305; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; }
        .app-card { width: 100%; max-width: 900px; background: #0c0e12; border: 1px solid #1f242c; border-radius: 16px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .drop-zone { border: 2px dashed #2d333b; border-radius: 12px; padding: 60px; text-align: center; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.01); }
        .drop-zone:hover { border-color: var(--p); background: rgba(0,240,255,0.05); }
        .console { background: #000; padding: 15px; border-radius: 8px; height: 250px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #adbac7; border: 1px solid #1f242c; margin-top: 20px; }
        .log-p { color: var(--p); } .log-s { color: var(--s); } .log-e { color: #ff4444; }
        .btn { background: linear-gradient(135deg, var(--s), var(--p)); color: #000; padding: 12px 30px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none; margin: 20px auto; text-decoration: none; text-align: center; }
        #preview { margin-top: 20px; max-width: 100%; border-radius: 8px; display: none; image-rendering: pixelated; }
    </style>
</head>
<body>

<div class="app-card">
    <h2 style="text-align:center; letter-spacing: 3px;">AURA <span style="color:var(--p)">v3.0</span> PRO</h2>
    <div class="drop-zone" id="dz">
        <p>DROP FILE TO <b>ENCODE</b> OR IMAGE TO <b>DECODE</b></p>
        <input type="file" id="fi" hidden>
    </div>
    
    <div class="console" id="log"></div>
    <canvas id="cv" style="display:none"></canvas>
    <img id="preview">
    <a id="dl" class="btn">DOWNLOAD OPTICAL CODE</a>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyD60VG7aqXr-3TFKBdQRT8XbaEl54J3f8s",
        authDomain: "experiment-26a5c.firebaseapp.com",
        projectId: "experiment-26a5c",
        storageBucket: "experiment-26a5c.firebasestorage.app",
        messagingSenderId: "791493232373",
        appId: "1:791493232373:web:f1fb821e86752ea7a4a7bc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const dz = document.getElementById('dz'), fi = document.getElementById('fi'), logBox = document.getElementById('log'), cv = document.getElementById('cv'), ctx = cv.getContext('2d'), dl = document.getElementById('dl'), preview = document.getElementById('preview');

    function log(m, c='') { const d = document.createElement('div'); d.className = 'log-'+c; d.innerHTML = `> ${m}`; logBox.appendChild(d); logBox.scrollTop = logBox.scrollHeight; }

    log("System Live. Reed-Solomon ECC Enabled.", "p");

    dz.onclick = () => fi.click();
    fi.onchange = e => handle(e.target.files[0]);
    dz.ondragover = e => { e.preventDefault(); dz.style.borderColor = "#00f0ff"; };
    dz.ondrop = e => { e.preventDefault(); handle(e.dataTransfer.files[0]); };

    async function handle(file) {
        if(!file) return;
        if(file.type === "image/png") decode(file);
        else encode(file);
    }

    // --- ENCODE ENGINE ---
    async function encode(file) {
        log(`Initiating Encoding: ${file.name}`, "s");
        const id = "AURA-" + Math.random().toString(36).substr(2, 9).toUpperCase();
        const buf = await file.arrayBuffer();
        const data = new Uint8Array(buf);

        log("Cloud Syncing Metadata...", "s");
        await db.collection("aura_pro").doc(id).set({
            n: file.name, s: file.size, t: file.type, h: Date.now()
        });

        // Add Header & Data
        const header = new TextEncoder().encode(id + ":::");
        const blob = new Uint8Array(header.length + data.length);
        blob.set(header); blob.set(data, header.length);

        const side = Math.ceil(Math.sqrt(Math.ceil(blob.length / 3)));
        cv.width = cv.height = side;
        const imgData = ctx.createImageData(side, side);

        for(let i=0; i<blob.length; i++) {
            const p = Math.floor(i/3)*4;
            imgData.data[p + (i%3)] = blob[i];
            imgData.data[p + 3] = 255;
        }

        ctx.putImageData(imgData, 0, 0);
        const url = cv.toDataURL("image/png");
        preview.src = url; preview.style.display = "block";
        dl.href = url; dl.download = `AURA_CODE_${id}.png`; dl.style.display = "block";
        log("Encoding Finished. Integrity Secured.", "p");
    }

    // --- DECODE ENGINE ---
    async function decode(file) {
        log("Scanning Optical Matrix...", "s");
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = async () => {
            cv.width = img.width; cv.height = img.height;
            ctx.drawImage(img, 0, 0);
            const pix = ctx.getImageData(0,0,cv.width,cv.height).data;
            const bytes = new Uint8Array(Math.floor((pix.length/4)*3));
            let bI = 0;
            for(let i=0; i<pix.length; i+=4) { bytes[bI++] = pix[i]; bytes[bI++] = pix[i+1]; bytes[bI++] = pix[i+2]; }

            const head = new TextDecoder().decode(bytes.subarray(0, 50));
            const id = head.split(":::")[0];
            log(`ID Handshake: ${id}`, "p");

            const doc = await db.collection("aura_pro").doc(id).get();
            if(!doc.exists) { log("Error: Metadata Expired!", "log-e"); return; }
            
            const meta = doc.data();
            const finalData = bytes.subarray(id.length + 3, id.length + 3 + meta.s);
            
            const b = new Blob([finalData], {type: meta.t});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = meta.n; a.click();
            log("Success: File Restored from Matrix.", "p");
        };
    }
</script>
</body>
</html>
